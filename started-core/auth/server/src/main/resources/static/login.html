<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统一登录</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="./css/index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div id="app">
    <div class="login-container">
        <div class="login-card">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <h1>统一登录</h1>
                <p>登录以继续访问您的账户</p>
            </div>

            <form @submit.prevent="handleLogin">
                <div class="form-group">
                    <label for="username">用户名</label>
                    <div class="input-with-icon">
                        <i class="fas fa-user"></i>
                        <input
                                type="text"
                                id="username"
                                class="form-control"
                                placeholder="请输入用户名或邮箱"
                                v-model="form.username"
                                :class="{ 'error': errors.username }"
                        >
                    </div>
                    <div class="error-message" v-if="errors.username">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ errors.username }}
                    </div>
                </div>

                <div class="form-group">
                    <label for="password">密码</label>
                    <div class="input-with-icon">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" class="form-control" placeholder="请输入密码"
                               v-model="form.password" :class="{ 'error': errors.password }">
                    </div>
                    <div class="error-message" v-if="errors.password">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ errors.password }}
                    </div>
                </div>

                <div class="options">
                    <div class="remember-me">
                        <input type="checkbox" id="remember" v-model="form.remember">
                        <label for="remember">记住我</label>
                    </div>
                    <a href="#" class="forgot-password">忘记密码？</a>
                </div>

                <button type="submit" class="btn-login" :disabled="loading">
                    <span v-if="loading" class="loading"></span>
                    <i v-else class="fas fa-sign-in-alt"></i>
                    {{ loading ? '登录中...' : '登录' }}
                </button>
            </form>

            <div class="signup-link">
                还没有账户？<a href="#" @click.prevent="showRegister = true">立即注册</a>
            </div>
        </div>
    </div>

    <!-- 注册模态框 -->
    <div class="modal-overlay" v-if="showRegister" @click="showRegister = false">
        <div class="modal-content" @click.stop>
            <div class="modal-header">
                <h3>用户注册</h3>
                <button class="close-btn" @click="showRegister = false">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="reg-username">用户名</label>
                    <input
                            type="text"
                            id="reg-username"
                            class="form-control"
                            placeholder="请输入用户名"
                            v-model="registerForm.username"
                    >
                </div>
                <div class="form-group">
                    <label for="reg-password">密码</label>
                    <input
                            type="password"
                            id="reg-password"
                            class="form-control"
                            placeholder="请输入密码（至少6位）"
                            v-model="registerForm.password"
                    >
                </div>
                <div class="form-group">
                    <label for="reg-confirm-password">确认密码</label>
                    <input
                            type="password"
                            id="reg-confirm-password"
                            class="form-control"
                            placeholder="请再次输入密码"
                            v-model="registerForm.confirmPassword"
                    >
                </div>
                <div class="cf-turnstile" data-sitekey="0x4AAAAAAB8NwsG5dVkt3JZY"
                     data-theme="auto"
                     data-size="flexible"
                     data-callback="onTurnstileSuccess"
                     data-error-callback="onTurnstileError"
                     data-expired-callback="onTurnstileExpired"></div>
                <button class="btn-register" @click="handleRegister" :disabled="registerLoading">
                    <span v-if="registerLoading" class="loading"></span>
                    {{ registerLoading ? '注册中...' : '注册' }}
                </button>
            </div>
        </div>
    </div>

    <div class="notification" :class="[notification.type, { show: notification.show }]">
        <i class="fas" :class="notification.type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'"></i>
        {{ notification.message }}
    </div>
</div>

<script>
    const {createApp} = Vue;

    createApp({
        data() {
            return {
                form: {
                    username: '',
                    password: '',
                    remember: false
                },
                registerForm: {
                    username: '',
                    password: '',
                    confirmPassword: ''
                },
                errors: {
                    username: '',
                    password: ''
                },
                loading: false,
                registerLoading: false,
                showRegister: false,
                notification: {
                    show: false,
                    message: '',
                    type: 'success'
                },
                // Token存储
                tokens: {
                    accessToken: localStorage.getItem('access_token'),
                    refreshToken: localStorage.getItem('refresh_token')
                }
            };
        },
        methods: {
            validateForm() {
                this.errors = {username: '', password: ''};
                let isValid = true;

                if (!this.form.username) {
                    this.errors.username = '请输入用户名或邮箱';
                    isValid = false;
                }

                if (!this.form.password) {
                    this.errors.password = '请输入密码';
                    isValid = false;
                } else if (this.form.password.length < 6) {
                    this.errors.password = '密码长度不能少于6位';
                    isValid = false;
                }

                return isValid;
            },

            validateRegisterForm() {
                if (!this.registerForm.username) {
                    this.showNotification('请输入用户名', 'error');
                    return false;
                }
                if (!this.registerForm.password) {
                    this.showNotification('请输入密码', 'error');
                    return false;
                }
                if (this.registerForm.password.length < 6) {
                    this.showNotification('密码长度不能少于6位', 'error');
                    return false;
                }
                if (this.registerForm.password !== this.registerForm.confirmPassword) {
                    this.showNotification('两次输入的密码不一致', 'error');
                    return false;
                }
                return true;
            },

            async handleLogin() {
                if (!this.validateForm()) {
                    return;
                }

                this.loading = true;

                try {
                    const url = new URL(window.location.href);
                    const uuid = url.searchParams.get('uuid');

                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            uuid: uuid,
                            username: this.form.username,
                            password: this.form.password
                        })
                    });


                    if (!response.ok) {
                        throw new Error(data.msg || '登录失败');
                    }
                    const data = await response.json();

                    if (data.success) {
                        // 保存token到localStorage
                        localStorage.setItem('access_token', data.access_token);
                        localStorage.setItem('refresh_token', data.refresh_token);

                        this.showNotification('登录成功！正在跳转...', 'success');
                        // todo
                        if ((uuid || '').length > 5) {
                            let href = window.atob(url.searchParams.get('urlBack'));
                            console.log('即将跳转', href)
                            window.location.href = href
                        } else {
                            // 跳转到首页或仪表板
                            window.location.href = 'dashboard/index.html';
                        }
                    } else {
                        this.showNotification(data.msg || '登录失败', 'error');
                    }
                } catch (error) {
                    console.error('登录错误:', error);
                    this.showNotification('登录失败，请检查网络连接', 'error');
                } finally {
                    this.loading = false;
                }
            },

            async handleRegister() {
                if (!this.validateRegisterForm()) {
                    return;
                }

                this.registerLoading = true;

                try {
                    const response = await this.realRegister();

                    if (response.success) {
                        this.showNotification('注册成功！请登录', 'success');
                        this.showRegister = false;
                        this.registerForm = {username: '', password: '', confirmPassword: ''};
                    } else {
                        this.showNotification(response.msg || '注册失败', 'error');
                    }
                } catch (error) {
                    console.error('注册错误:', error);
                    this.showNotification('注册失败，请稍后重试', 'error');
                } finally {
                    this.registerLoading = false;
                }
            },

            async realLogin() {

                return data;
            },

            async realRegister() {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: this.registerForm.username,
                        password: this.registerForm.password
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.msg || '注册失败');
                }

                return data;
            },

            showNotification(message, type) {
                this.notification.message = message;
                this.notification.type = type;
                this.notification.show = true;

                setTimeout(() => {
                    this.notification.show = false;
                }, 3000);
            },

            // Token刷新功能
            async refreshToken() {
                const refreshToken = localStorage.getItem('refresh_token');
                if (!refreshToken) {
                    return null;
                }

                try {
                    const response = await fetch('/api/auth/refresh', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            refresh_token: refreshToken
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        localStorage.setItem('access_token', data.data.access_token);
                        localStorage.setItem('refresh_token', data.data.refresh_token);
                        return data.data.access_token;
                    } else {
                        // 刷新失败，清除token
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('refresh_token');
                        return null;
                    }
                } catch (error) {
                    console.error('Token刷新失败:', error);
                    return null;
                }
            },

            // 检查登录状态
            checkLoginStatus() {
                const accessToken = localStorage.getItem('access_token');
                if (accessToken) {
                    // 如果有token，直接跳转到仪表盘
                    console.log('用户已登录，自动跳转到仪表盘');
                    window.location.href = 'dashboard/index.html';
                }
            }
        },
        mounted() {
            // 检查是否已登录，如果已登录则自动跳转
            this.checkLoginStatus();
        }
    }).mount('#app');
</script>
<script
        src="https://challenges.cloudflare.com/turnstile/v0/api.js"
        async
        defer
></script>
</body>
</html>